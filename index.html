<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>YANNIC KÖBI AKTIEN HANDEL AG</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.2.0/dist/tf.min.js"></script>
<link rel="stylesheet" href="style.css">
</head>
<body>
<h1>YANNIC KÖBI AKTIEN HANDEL AG</h1>
<select id="stockSelect"></select>
<select id="timeSelect">
  <option value="30">1 Monat</option>
  <option value="60">2 Monate</option>
  <option value="90" selected>3 Monate</option>
</select>
<button onclick="analyze()">Analyse durchführen</button>
<canvas id="chart"></canvas>
<div id="result"></div>
<script>
"use strict";
const STOCKS=[{s:"AAPL",n:"Apple"},{s:"MSFT",n:"Microsoft"},{s:"PYPL",n:"PayPal"}];
const select=document.getElementById("stockSelect");
STOCKS.forEach(a=>{const o=document.createElement("option");o.value=a.s;o.textContent=a.s+" – "+a.n;select.appendChild(o);});
let chart;

async function fetchCurrentPrice(symbol){
  const res=await fetch(`/.netlify/functions/finnhub?symbol=${symbol}&type=quote`);
  const data=await res.json();
  if(!data||!data.c) throw new Error("Keine aktuellen Kursdaten für "+symbol);
  return data.c;
}

async function fetchCandle(symbol,days){
  const res=await fetch(`/.netlify/functions/finnhub?symbol=${symbol}&type=candle&days=${days}`);
  const data=await res.json();
  if(!data||data.s!=="ok"||!data.c||data.c.length===0) return null;
  return data.c;
}

async function fetchUSDtoCHF(){
  const res=await fetch("https://api.exchangerate.host/latest?base=USD&symbols=CHF");
  const data=await res.json();
  return data.rates.CHF||0.93;
}

function drawChart(prices,forecast){
  if(chart) chart.destroy();
  const labels=[];
  for(let i=1;i<=prices.length;i++) labels.push(`T${i}`);
  for(let i=1;i<=forecast.length;i++) labels.push(`F${i}`);
  chart=new Chart(document.getElementById("chart"),{
    type:"line",
    data:{labels,datasets:[
      {label:"Kurs (CHF)",data:[...prices,...Array(forecast.length).fill(null)],borderColor:"#00ccaa",tension:0.3},
      {label:"KI-Prognose (CHF)",data:[...Array(prices.length).fill(null),...forecast],borderColor:"#ffaa55",tension:0.3}
    ]}
  });
}

async function predictWithAI(prices,forecastDays=7){
  const max=Math.max(...prices), min=Math.min(...prices);
  const norm=prices.map(p=>(p-min)/(max-min));
  const X=[],Y=[];
  for(let i=0;i<norm.length-5;i++){ X.push(norm.slice(i,i+5)); Y.push(norm[i+5]); }
  const xs=tf.tensor2d(X), ys=tf.tensor2d(Y,[Y.length,1]);
  const model=tf.sequential();
  model.add(tf.layers.dense({units:10,activation:"relu",inputShape:[5]}));
  model.add(tf.layers.dense({units:1}));
  model.compile({optimizer:"adam",loss:"meanSquaredError"});
  await model.fit(xs,ys,{epochs:50,verbose:0});
  let last=norm.slice(-5);
  const forecast=[];
  for(let i=0;i<forecastDays;i++){
    const input=tf.tensor2d([last]);
    const pred=model.predict(input).dataSync()[0];
    forecast.push(pred*(max-min)+min);
    last=last.slice(1); last.push(pred);
  }
  return forecast;
}

async function analyze(){
  const symbol=select.value;
  const days=parseInt(document.getElementById("timeSelect").value,10);
  const rate=await fetchUSDtoCHF();
  const currentUSD=await fetchCurrentPrice(symbol);
  const pricesUSD=await fetchCandle(symbol,days);
  const prices=pricesUSD?pricesUSD.map(p=>p*rate):[currentUSD*rate];
  const forecast=pricesUSD?await predictWithAI(prices,Math.min(days,14)):[currentUSD*rate];
  drawChart(prices,forecast);
  document.getElementById("result").textContent=`Aktuell: ${(currentUSD*rate).toFixed(2)} CHF, Prognose: ${forecast.at(-1).toFixed(2)} CHF`;
}
</script>
</body>
</html>
